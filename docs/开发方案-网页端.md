# WorkSentry 网页端开发方案（单体部署 / 单域名）

更新时间：2026-01-30

## 0. 目标

用一个可直接部署的服务（一个域名即可访问）一次性交付以下能力：

- 实时监控大屏：按部门分组的“红绿墙”，2 秒内状态变更可见
- 规则配置中心：黑名单/白名单/闲置阈值/心跳与离线阈值等参数在线修改，立即生效
- 数据报表：个人时间轴、日统计、团队排行、导出
- 异常闭环：离线、系统事故、强制更新熔断、离线段手动补录（仅覆盖离线段）

## 1. 范围（明确不做什么）

- 不做任何薪资、扣薪、计薪、排班、考勤结算逻辑
- 不做截图/录屏/键盘记录等高敏功能
- 不在网页端展示数据库内部主键、枚举原始值、时间戳原始值；统一转为可读中文

## 2. 部署形态（一个域名直接部署完成）

- 一个 Go 服务进程同时提供：
  - 管理端页面（前端静态资源或模板页面）
  - 管理端 API
  - 客户端 API
  - WebSocket 推送
- 前端构建产物打包进 Go 二进制（`embed`），部署时只需要：
  - 一个可执行文件
  - 一个配置文件
  - 一个数据库

说明：可以在同一域名下按路径区分：
- `/`：管理端页面
- `/api/...`：HTTP API
- `/ws/...`：WebSocket

## 3. 技术选型（Go）

- Go 版本：Go 1.22+（建议）
- Web：标准库 `net/http` + 轻量中间件（可替换 Gin，但非必须）
- 数据库：MySQL
- ORM：sqlc（SQL 优先，类型安全）
- 数据迁移：golang-migrate（或 goose）
- WebSocket：nhooyr/websocket（实时墙）
- 定时任务：robfig/cron（原始流水清理、离线判定刷新）

前端路径（仍为单域名单体部署）：
- 推荐：Vue3 + Vite + Element Plus（构建后的 `dist/` 由 Go 嵌入并静态托管）
- 备选：Go 模板/templ + 少量原生 JS（更轻，但交互复杂度上升）

## 4. 业务口径（必须写死到代码里）

### 4.1 状态定义与优先级

- 离开：键鼠闲置超过阈值
- 摸鱼：命中黑名单
- 工作：命中白名单
- 常规：未命中黑白（算在岗但不算有效工时）
- 离线：超过离线阈值未收到任何心跳/上报
- 系统事故：服务端侧监控失效的记录（用于解释，不自动折算为工作/常规/摸鱼）

优先级（从高到低）：离开 > 摸鱼（黑优先）> 工作 > 常规

### 4.2 时间口径（只做行为审计，不做薪资）

- 物理在岗：工作 + 常规 + 摸鱼
- 有效工时：工作

### 4.3 计时规则（左闭右开）

- 所有时长以服务端收包时间为准（仅用于审计统计）
- 两次相邻报文之间的时间段，归属于“前一个报文”的状态（Left-Closed, Right-Open）

离线阈值是唯一分界线（无罪推定）：
- 若两次报文间隔 `<= 离线阈值`：整段归前一个状态
- 若两次报文间隔 `> 离线阈值`：整段标记为离线（不归前一个状态）

实时大屏显示规则：
- 未超阈：显示“上一次状态 + 心跳延迟倒计时”
- 超阈：变灰显示离线

## 5. 数据模型（建议）

说明：下列括号内为建议字段标识（仅用于开发对齐）。

### 5.1 员工与组织

- 员工（`employees`）
  - 工号（employee_code）、姓名、部门、启用状态
  - 绑定的硬件指纹（fingerprint_hash）

- 部门（`departments`）
  - 部门名称、上级部门

### 5.2 规则与配置

- 规则（`rules`）
  - 类型：白/黑
  - 匹配方式：进程名匹配/标题关键词匹配
  - 匹配值：例如 `telegram.exe`、`SaleSmartly`、`bilibili`
  - 启用状态、备注

- 全局配置（`settings`）
  - 闲置阈值、心跳间隔、离线阈值
  - 摸鱼比例阈值（可配置）
  - 更新策略参数（强制/提示）

### 5.3 上报原始数据（保留 7 天）

- 原始流水（`raw_events`）
  - 工号、服务端收包时间
  - 进程名、窗口标题、闲置秒数
  - 客户端版本、IP

### 5.4 用于报表的“时间段”与“日统计”（长期保留）

- 系统计算的时间段（`time_segments`）
  - 工号、开始时间、结束时间
  - 状态、简要描述（例如“Chrome：SaleSmartly”）
  - 来源：系统/离线/手动/系统事故

- 日统计（`daily_stats`）
  - 日期 + 工号（唯一）
  - 各状态累计秒数：工作/常规/摸鱼/离开/离线
  - 物理在岗秒数、有效工时秒数

### 5.5 异常与审计

- 手动补录（`manual_adjustments`）
  - 仅允许覆盖“离线段”，补录结果只记为“有效工时”
  - 开始/结束时间、原因、备注（必填）
  - 操作者、撤销/修改记录

- 系统事故（`system_incidents`）
  - 开始/结束时间、原因、备注、创建人

- 操作审计（`audit_logs`）
  - 谁在什么时候做了什么（规则增删改、阈值修改、补录、事故标记等）

## 6. 功能清单（网页端）

### 6.1 实时监控大屏

- 部门分组、搜索、状态图例
- 以“状态中文 + 简要描述 + 心跳延迟倒计时”展示
- 不展示内部 ID/枚举值/原始时间戳

### 6.2 规则配置中心

- 黑白名单标签化录入（输入回车即添加）
- 规则启用/停用、编辑、删除
- 黑优先规则固定，不可切换

### 6.3 全局阈值与更新策略

- 闲置阈值、心跳间隔、离线阈值、摸鱼比例阈值
- 更新策略：强制/提示
- 修改后立即生效（服务端热更新）

### 6.4 数据报表

- 个人时间轴（按天）
- 日统计汇总（按部门/个人）
- 团队排行与摸鱼比例提示（阈值可配置）
- 导出：Excel

### 6.5 异常与审计

- 离线段列表 + 一键补录
- 系统事故登记与查询
- 操作审计查询

## 7. 核心接口（建议）

### 7.1 客户端接口

- 设备绑定：`POST /api/v1/client/bind`
  - 入参：工号、硬件指纹
  - 出参：访问令牌、心跳间隔、阈值配置、更新策略与版本信息

- 上报/心跳：`POST /api/v1/client/report`
  - 入参：进程名、窗口标题、闲置秒数、客户端版本
  - 出参：阈值配置、最新版本、更新策略（强制/提示）

约束：服务端以收包时间为准；客户端上报的“持续时长”仅作为一致性校验参考。

### 7.2 管理端接口

- 登录/会话：`POST /api/v1/admin/login`
- 规则管理：`GET/POST/PUT/DELETE /api/v1/admin/rules`
- 阈值配置：`GET/PUT /api/v1/admin/settings`
- 实时墙数据：`GET /api/v1/admin/live-snapshot`
- 报表查询：`GET /api/v1/admin/reports/daily`、`/timeline`
- 导出：`GET /api/v1/admin/exports/daily.xlsx`
- 手动补录：`POST/PUT/DELETE /api/v1/admin/manual-adjustments`
- 系统事故：`POST/PUT/DELETE /api/v1/admin/system-incidents`
- 操作审计：`GET /api/v1/admin/audit-logs`

## 8. 实时推送（WebSocket）

- 连接：`GET /ws/v1/live`
- 推送策略：只推“增量变化”，避免每次全量刷新 1000 人列表
- 消息只包含展示字段：姓名、工号、部门、中文状态、简要描述、最后上报时间（格式化后）
- 禁止直接传/展示数据库内部数值 ID

## 9. 统计与定时任务

- 日统计写入策略：在“报文入库”时增量累计
- 处理跨天：按自然日切分时间段并分别累计
- 原始流水清理：每天定时删除 7 天前数据
- 离线判定刷新：按离线阈值更新状态视图

## 10. 安全与展示规范

- 仅最小化登录能力（管理端会话即可），不引入复杂权限体系
- 所有页面展示中文文案，不展示内部 ID/枚举值/原始时间戳
- 所有修改操作写入审计日志


### 10.1 视觉与排版规范

- 视觉基调：专业、克制、对比清晰；默认浅色背景，支持暗色模式切换
- 主色 #6366F1，辅助色 #818CF8，强调/操作色 #10B981
- 背景 #F5F3FF，正文 #1E1B4B；文本对比度≥4.5:1
- 字体：Plus Jakarta Sans；中文回退：思源黑体/苹方/微软雅黑（按系统自动回退）
- 交互：按钮与可点元素均有悬停与焦点态（150-300ms），键盘可操作

### 10.2 页面结构与导航

- 顶部栏：系统名、当前日期、管理员信息、退出
- 左侧菜单：实时墙 / 规则 / 阈值与更新 / 报表 / 异常与审计 / 组织与员工
- 页面统一结构：筛选区 + 内容区 + 操作区，避免堆叠按钮

### 10.3 实时大屏展示细则

- 状态颜色：工作绿、常规蓝、摸鱼红、离开黄、离线灰、系统事故紫
- 展示字段：姓名、工号、部门、状态中文、简要描述、心跳倒计时
- 未超阈值：显示倒计时；超阈值：直接灰化
- 图标使用线性图标库，禁止表情符号替代

### 10.4 表单与输入规则

- 自动获取 > 选项选择 > 手动输入
- 时间选择统一为日期+时间选择器，提供常用快捷范围
- 删除/撤销等危险操作必须二次确认
- 错误提示：字段下方 + 页面顶部统一提示

### 10.5 响应式与性能

- 断点建议：375 / 768 / 1024 / 1440
- 内容内边距按断点调整，移动端隐藏次要信息
- 图片与图表采用自适应尺寸，避免大图全端加载

## 11. 数据保留与导出

- 原始流水：仅保留 7 天
- 日统计/手动补录/系统事故/操作审计：长期保留
- 导出字段全部使用中文列名，不包含内部 ID

## 12. 一次性交付清单

- 管理端页面：实时墙、规则配置、阈值设置、报表、异常与审计
- 管理端 API：完整 CRUD 与导出接口
- 客户端 API：绑定、上报、下发配置与更新策略
- WebSocket：实时墙增量推送
- 定时任务：原始流水清理与离线判定刷新


