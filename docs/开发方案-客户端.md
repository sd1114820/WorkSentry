# WorkSentry Windows 客户端开发方案（Windows Agent）

更新时间：2026-01-30

## 0. 目标

客户端只做三件事：采集、智能上报、按服务端指令更新。

- 稳定采集：前台窗口（进程名 + 窗口标题）与键鼠闲置时长
- 智能上报：状态变化立即上报 + 定时心跳兜底（降低流量与服务端压力）
- 身份绑定：工号 + 硬件指纹绑定，后续用令牌静默登录
- 动态配置：闲置阈值、心跳间隔、离线阈值等由服务端下发，客户端热更新
- 更新策略：支持“强制更新 / 启动提示更新”两种

明确不做：
- 不做规则判定（工作/摸鱼由服务端统一判定）
- 不做断网缓存（断网时不补传历史）
- 不做截图/录屏/键盘记录等高敏能力

## 1. 程序形态（用户感知）

- 默认无主界面，常驻托盘
- 首次运行：弹出窗口要求输入工号
- 强制更新：启动即弹窗提示更新，不确认更新则无法进入监控（熔断）
- 提示更新：启动/运行时提醒“有新版本”，用户可选择稍后更新

## 2. 技术选型（推荐）

客户端需要：托盘、弹窗、Win32 API 调用、安装/更新体验。

- 推荐：C# + .NET 8（WinForms 或 WPF）
  - 原因：Windows UI 与系统 API 生态成熟，部署与签名方案完整

备选：Go（可行但 UI 与 Win32 细节成本更高），仅当团队 Go 经验显著更强时考虑。

## 3. 关键采集能力（Win32）

- 闲置检测：读取“最后一次键鼠输入时间”，计算闲置秒数
- 前台窗口：获取当前激活窗口句柄，读取窗口标题
- 进程名：由窗口关联进程获取可执行文件名（统一转为小写用于对齐）

采集注意事项：
- 部分窗口标题可能为空/获取失败：允许上报空标题
- 权限差异可能导致进程信息不可读：至少保证能拿到窗口标题；进程名拿不到时上报空值并标记采集降级

## 4. 本地存储（只存最小必要信息）

建议目录：`%ProgramData%\WorkSentry\`（普通用户可读写有限内容，避免写到用户目录散落）

本地文件：
- 配置（config.json）：服务端地址、工号、当前版本、最近一次配置下发时间
- 令牌：使用系统加密能力保存（例如 DPAPI），不明文落盘
- 运行日志（可选）：按天滚动，最多保留 7 天，用于排查“为什么离线/为什么不更新”

## 5. 采集循环（5 秒一次）

- 采样周期：5 秒
- 采样内容：
  - 闲置秒数
  - 进程名
  - 窗口标题

客户端只做“变化检测”，不做状态判定：
- 缓存上一次采样
- 触发“立即上报”的变化：
  - 前台应用切换（进程名变化）
  - 窗口标题变化（同进程内切页面/聊天）
  - 闲置阈值穿越（从未超阈到超阈，或从超阈回到未超阈）

心跳兜底：
- 即使没有任何变化，也必须按心跳间隔定时上报一次，证明“客户端还在线”

## 6. 上报与协议（对齐服务端口径）

- 传输：HTTPS + JSON
- 鉴权：令牌放在请求头（例如 `Authorization`）
- 以服务端收包时间为准：客户端不参与计时口径

推荐统一一个接口：
- `POST /api/v1/client/report`

入参建议（括号内为字段标识，仅用于开发对齐）：
- 工号（employee_code）：仅在首次绑定或令牌失效时携带
- 硬件指纹（fingerprint）：仅在首次绑定或令牌失效时携带
- 进程名（process_name）
- 窗口标题（window_title）
- 闲置秒数（idle_seconds）
- 客户端版本（client_version）
- 上报类型：变化上报/心跳/启动（report_type）

服务端响应建议：
- 心跳间隔、闲置阈值、离线阈值（用于热更新）
- 最新版本号
- 更新策略（强制/提示）与下载地址、校验值

网络失败策略：
- 不做历史补传，不做离线缓存
- 失败后进入退避重试（例如 5 秒、15 秒、30 秒…上限 5 分钟）
- 只要恢复网络，继续按“变化 + 心跳”上报

## 7. 更新机制（强制更新 / 启动提示更新）

### 7.1 启动阶段

- 启动后第一件事：向服务端获取“版本与更新策略”
- 若服务端要求强制更新且本地版本落后：
  - 弹窗提示更新
  - 用户不点击“确定更新”则直接退出（不进入监控，不上报）

### 7.2 下载与安装

- 下载更新包到临时目录
- 校验：至少做 SHA256 校验；有条件可做签名校验
- 安装方式建议：
  - 使用安装包（Installer）统一升级，减少替换 EXE 的细节坑
  - 安装完成后自动重启客户端

### 7.3 运行中触发强制更新

- 若运行中服务端切换为强制更新：
  - 立即提示并停止继续监控（熔断）
  - 用户确认更新后再恢复运行

## 8. 稳定性与防作弊（建议里程碑分期）

- 必须项（MVP）：
  - 开机自启
  - 单实例运行（避免多开重复上报）

- 可选增强（后续）：
  - 双进程守护或服务化（降低被结束进程的概率）
  - 关键配置防篡改（例如服务端地址变更需管理员签名）

## 9. 安装包与分发

- 输出：`WorkSentry_Installer.exe`
- 安装后：自动创建自启动项（开机登录后启动）
- 卸载：清理程序文件；本地配置是否保留由业务决定（建议默认清理）

## 10. 里程碑拆分（建议）

- M1：绑定 + 采集 + 变化/心跳上报（最小可用）
- M2：托盘交互 + 启动提示更新
- M3：强制更新熔断 + 下载校验 + 安装与自恢复
- M4：稳定性增强（守护/服务化，可选）
